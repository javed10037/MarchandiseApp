'use strict';

var Error = require('../error');

module.exports = function (req, res, next) {
  if (!req.get('HMAC') || !req.body || !req.body.ipn_mode || req.body.ipn_mode !== 'hmac' || merchantId !== req.body.merchant) {
    return next(new Error('CoinPayments IPN: Bad request', {
      headers: req.headers,
      body: req.body
    }));
  }
  hmac = this.getPrivateHeadersIPN(req[rawBodyIndex]);
  if (hmac !== req.get('HMAC')) {
    return next(new Error('CoinPayments IPN: Invalid request'), {});
  }
  res.end();
  if (req.body.status < 0) {
    this.emit('ipn_fail', req.body);
    return next();
  }
  if (req.body.status < 100) {
    this.emit('ipn_pending', req.body);
    return next();
  }
  if (req.body.status === 100) {
    this.emit('ipn_complete', req.body);
    return next();
  }
};